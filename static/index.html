<!doctype html>
<html lang="en" class="h-full">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>FSQD</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link
            href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap"
            rel="stylesheet"
        />
        <link
            href="https://fonts.googleapis.com/icon?family=Material+Icons"
            rel="stylesheet"
        />
        <style>
            .material-icons {
                font-size: 20px;
                vertical-align: middle;
            }
            .btn-icon {
                @apply p-2 rounded-full hover:bg-white/10 transition-colors;
            }
            .btn-icon:disabled {
                @apply text-muted-foreground cursor-not-allowed hover:bg-transparent;
            }
        </style>
        <script
            defer
            src="//unpkg.com/alpinejs@3.14.1/dist/cdn.min.js"
        ></script>
        <script>
            tailwind.config = {
                theme: {
                    extend: {
                        colors: {
                            background: "#1f2430",
                            surface: "#242936",
                            foreground: "#cbccc6",
                            "muted-foreground": "#5c6773",
                            primary: {
                                DEFAULT: "#ffad40",
                                foreground: "#1f2430",
                            },
                            destructive: "#ff5c57",
                            green: "#bae67e",
                            blue: "#73d0ff",
                            yellow: "#ffd580",
                        },
                        fontFamily: {
                            sans: ["Roboto", "sans-serif"],
                        },
                    },
                },
            };
        </script>
    </head>
    <body class="h-full bg-background text-foreground font-sans">
        <div class="min-h-full flex flex-col" x-data="queueApp">
            <!-- Header -->
            <header class="bg-surface shadow-md">
                <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-4">
                    <h1
                        class="text-2xl font-bold text-foreground flex items-center gap-2"
                    >
                        <span
                            class="material-icons text-primary"
                            style="font-size: 28px"
                            >download_for_offline</span
                        >
                        FSQD - fastshare.cloud Downloader
                        <span
                            class="text-sm text-muted-foreground font-normal ml-2"
                            >v2.0.0</span
                        >
                    </h1>
                </div>
            </header>

            <!-- Main Content -->
            <main
                class="flex-1 max-w-4xl mx-auto w-full px-4 sm:px-6 lg:px-8 py-8"
            >
                <!-- Input Section -->
                <div class="bg-surface rounded-xl shadow-lg p-6 mb-8">
                    <label
                        for="link-input"
                        class="block text-sm font-medium text-foreground mb-2"
                        >FastShare Link</label
                    >
                    <div class="flex flex-col sm:flex-row gap-3">
                        <input
                            type="url"
                            id="link-input"
                            name="url"
                            placeholder="https://fastshare.cloud/..."
                            class="flex-1 px-4 py-2 bg-background border border-muted-foreground/30 rounded-lg shadow-sm focus:outline-none focus:ring-2 focus:ring-primary focus:border-primary"
                        />
                        <button
                            type="button"
                            @click="addToQueue()"
                            class="px-5 py-2 bg-primary text-primary-foreground font-bold rounded-lg hover:bg-primary/90 focus:outline-none focus:ring-2 focus:ring-primary focus:ring-offset-2 focus:ring-offset-background transition-colors flex items-center justify-center gap-2"
                        >
                            <span class="material-icons">add_to_queue</span>
                            Add to Queue
                        </button>
                    </div>
                </div>

                <!-- Queue Section (now includes Active Downloads as first section) -->
                <div
                    id="queue-container"
                    class="bg-surface rounded-xl shadow-lg p-6"
                >
                    <!-- Active Downloads Section -->
                    <h2
                        class="text-xl font-bold text-foreground mb-3 flex items-center gap-2"
                    >
                        <span class="material-icons text-primary"
                            >downloading</span
                        >
                        Active Downloads
                    </h2>
                    <template x-if="(queue.downloading || []).length === 0">
                        <div class="text-muted-foreground text-center py-6">
                            <div class="material-icons text-4xl mb-2">
                                cloud_download
                            </div>
                            <div>
                                No active downloads.
                            </div>
                        </div>
                    </template>
                    <template x-for="item in (queue.downloading || [])" :key="item.id">
                        <div
                            class="bg-background/50 rounded-lg p-4 transition-shadow mb-3 border border-transparent hover:border-primary/50"
                            :id="'downloading-' + item.id"
                        >
                            <div class="flex items-start justify-between">
                                <div class="flex-1 min-w-0">
                                    <h3
                                        class="font-medium text-foreground truncate pr-4"
                                        x-text="item.name"
                                    ></h3>
                                    <a
                                        :href="item.link"
                                        target="_blank"
                                        rel="noopener noreferrer"
                                        class="text-sm text-blue hover:underline truncate block overflow-hidden text-ellipsis"
                                        x-text="item.link"
                                    >
                                    </a>
                                </div>
                                <div class="ml-4 flex items-center gap-1">
                                    <button
                                        class="btn-icon text-destructive"
                                        title="Stop Download"
                                        @click="cancelDownload(item.id)"
                                    >
                                        <span class="material-icons"
                                            >stop_circle</span
                                        >
                                    </button>
                                </div>
                            </div>
                            <div class="mt-3">
                                <div
                                    class="flex justify-between text-xs text-muted-foreground mb-1"
                                >
                                    <span>
                                        <span x-text="progressMap[item.id]?.progress ?? 0"></span>% complete
                                    </span>
                                    <span x-text="progressMap[item.id]?.downloadSpeed || '-'"></span>
                                </div>
                                <div
                                    class="w-full bg-background rounded-full h-1.5"
                                >
                                    <div
                                        class="bg-blue h-1.5 rounded-full"
                                        :style="'width: ' + (progressMap[item.id]?.progress ?? 0) + '%'"
                                    ></div>
                                </div>
                            </div>
                            <div
                                class="flex items-center justify-between mt-2 text-xs text-muted-foreground"
                            >
                                <span x-text="'Added: ' + formatDate(item.addedAt)"></span>
                                <div class="flex items-center gap-2">
                                    <span x-text="formatSize(item.size)"></span>
                                    <span
                                        class="inline-flex items-center gap-1.5 px-2 py-0.5 rounded-full font-medium bg-blue text-background"
                                    >
                                        <span
                                            class="material-icons"
                                            style="font-size: 14px"
                                            >downloading</span
                                        >
                                        downloading
                                    </span>
                                </div>
                            </div>
                        </div>
                    </template>

                    <!-- Queued Items -->
                    <h2
                        class="text-xl font-bold text-foreground mb-3 mt-6 flex items-center gap-2"
                    >
                        <span class="material-icons text-primary"
                            >queue</span
                        >
                        Queue
                    </h2>

                        <div
                            x-show="(queue.pending || []).length === 0"
                            class="text-muted-foreground text-center py-6"
                        >
                            <div class="material-icons text-4xl mb-2">
                                inbox
                            </div>
                            <div>
                                The queue is empty. Add a link to get started.
                            </div>
                        </div>

                        <template
                            x-for="(item, index) in (queue.pending || [])"
                            :key="item.id"
                        >
                            <div
                                class="bg-background/50 rounded-lg p-4 transition-shadow mb-3 border border-transparent hover:border-primary/50"
                            >
                                <div class="flex items-start justify-between">
                                    <div class="flex-1 min-w-0">
                                        <h3
                                            class="font-medium text-foreground truncate pr-4"
                                            x-text="item.name"
                                        ></h3>
                                        <a
                                            :href="item.link"
                                            target="_blank"
                                            rel="noopener noreferrer"
                                            class="text-sm text-blue hover:underline truncate block overflow-hidden text-ellipsis"
                                            x-text="item.link"
                                        >
                                        </a>
                                    </div>

                                    <div class="ml-4 flex items-center gap-1">
                                        <button
                                            class="btn-icon"
                                            title="Move up"
                                            @click="moveItem(item.id, 'up')"
                                            x-show="index !== 0"
                                        >
                                            <span class="material-icons"
                                                >arrow_upward</span
                                            >
                                        </button>
                                        <button
                                            class="btn-icon"
                                            title="Move down"
                                            @click="moveItem(item.id, 'down')"
                                            x-show="index !== queue.pending.length - 1"
                                        >
                                            <span class="material-icons"
                                                >arrow_downward</span
                                            >
                                        </button>
                                        <button
                                            class="btn-icon text-destructive"
                                            title="Remove"
                                            @click="deleteItem(item.id)"
                                        >
                                            <span class="material-icons"
                                                >delete</span
                                            >
                                        </button>
                                    </div>
                                </div>

                                <div
                                    class="flex items-center justify-between mt-2 text-xs text-muted-foreground"
                                >
                                    <span
                                        x-text="'Added: ' + formatDate(item.addedAt)"
                                    ></span>
                                    <div class="flex items-center gap-2">
                                        <span
                                            x-text="formatSize(item.size)"
                                        ></span>
                                        <span
                                            class="inline-flex items-center gap-1.5 px-2 py-0.5 rounded-full font-medium bg-yellow text-background"
                                        >
                                            <span
                                                class="material-icons"
                                                style="font-size: 14px"
                                                >hourglass_top</span
                                            >
                                            pending
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </template>

                        <!-- History -->
                        <div
                            class="flex items-center justify-between mt-8 mb-3"
                        >
                            <h2
                                class="text-xl font-bold text-foreground flex items-center gap-2"
                            >
                                <span class="material-icons text-primary"
                                    >history</span
                                >
                                History
                            </h2>
                            <div>
                                <button
                                    class="text-xs px-3 py-1 bg-destructive/20 text-destructive rounded-md hover:bg-destructive/30 transition-colors mr-2"
                                    x-show=" (queue.failed || []).length > 0 "
                                    @click="clearFailed()"
                                >
                                    Clear Failed
                                </button>
                                <button
                                    class="text-xs px-3 py-1 bg-green/20 text-green rounded-md hover:bg-green/30 transition-colors"
                                    x-show=" (queue.completed || []).length > 0 "
                                    @click="clearCompleted()"
                                >
                                    Clear Completed
                                </button>
                            </div>
                        </div>

                        <div
                            x-show="!(queue.failed || []).length && !(queue.completed || []).length"
                            class="text-muted-foreground text-center py-6"
                        >
                            <div class="material-icons text-4xl mb-2">
                                history_toggle_off
                            </div>
                            <div>Your download history is empty.</div>
                        </div>

                        <template
                            x-for="item in (queue.failed || [])"
                            :key="item.id"
                        >
                            <div
                                class="bg-background/50 rounded-lg p-4 transition-shadow mb-3 border border-transparent hover:border-primary/50"
                            >
                                <div class="flex items-start justify-between">
                                    <div class="flex-1 min-w-0">
                                        <h3
                                            class="font-medium text-foreground truncate pr-4"
                                            x-text="item.name"
                                        ></h3>
                                        <a
                                            :href="item.link"
                                            target="_blank"
                                            rel="noopener noreferrer"
                                            class="text-sm text-blue hover:underline truncate block overflow-hidden text-ellipsis"
                                            x-text="item.link"
                                        >
                                        </a>
                                    </div>

                                    <div class="ml-4 flex items-center gap-1">
                                        <button
                                            class="btn-icon text-blue"
                                            title="Retry Download"
                                            @click="retryItem(item.id)"
                                        >
                                            <span class="material-icons"
                                                >replay</span
                                            >
                                        </button>
                                        <button
                                            class="btn-icon text-destructive"
                                            title="Remove"
                                            @click="deleteItem(item.id)"
                                        >
                                            <span class="material-icons"
                                                >delete</span
                                            >
                                        </button>
                                    </div>
                                </div>

                                <div
                                    class="flex items-center justify-between mt-2 text-xs text-muted-foreground"
                                >
                                    <span
                                        x-text="'Added: ' + formatDate(item.addedAt)"
                                    ></span>
                                    <div class="flex items-center gap-2">
                                        <span
                                            class="inline-flex items-center gap-1.5 px-2 py-0.5 rounded-full font-medium bg-destructive text-background"
                                        >
                                            <span
                                                class="material-icons"
                                                style="font-size: 14px"
                                                >error</span
                                            >
                                            failed
                                        </span>
                                    </div>
                                </div>

                                <div
                                    class="text-xs text-destructive mt-2 p-2 bg-destructive/10 rounded"
                                    x-text="item.error"
                                ></div>
                            </div>
                        </template>

                        <template
                            x-for="item in (queue.completed || [])"
                            :key="item.id"
                        >
                            <div
                                class="bg-background/50 rounded-lg p-4 transition-shadow mb-3 border border-transparent hover:border-primary/50"
                            >
                                <div class="flex items-start justify-between">
                                    <div class="flex-1 min-w-0">
                                        <h3
                                            class="font-medium text-foreground truncate pr-4"
                                            x-text="item.name"
                                        ></h3>
                                        <a
                                            :href="item.link"
                                            target="_blank"
                                            rel="noopener noreferrer"
                                            class="text-sm text-blue hover:underline truncate block overflow-hidden text-ellipsis"
                                            x-text="item.link"
                                        >
                                        </a>
                                    </div>

                                    <div class="ml-4 flex items-center gap-1">
                                        <button
                                            class="btn-icon text-destructive"
                                            title="Remove"
                                            @click="deleteItem(item.id)"
                                        >
                                            <span class="material-icons"
                                                >delete</span
                                            >
                                        </button>
                                    </div>
                                </div>

                                <div class="mt-3">
                                    <div
                                        class="w-full bg-background rounded-full h-1.5"
                                    >
                                        <div
                                            class="bg-green h-1.5 rounded-full"
                                            style="width: 100%"
                                        ></div>
                                    </div>
                                </div>

                                <div
                                    class="flex items-center justify-between mt-2 text-xs text-muted-foreground"
                                >
                                    <span
                                        x-text="'Added: ' + formatDate(item.addedAt)"
                                    ></span>
                                    <div class="flex items-center gap-2">
                                        <span
                                            x-text="formatSize(item.size)"
                                        ></span>
                                        <span
                                            class="inline-flex items-center gap-1.5 px-2 py-0.5 rounded-full font-medium bg-green text-background"
                                        >
                                            <span
                                                class="material-icons"
                                                style="font-size: 14px"
                                                >check_circle</span
                                            >
                                            completed
                                        </span>
                                    </div>
                                </div>
                            </div>
                        </template>
                    </div>
                </div>
            </main>
        </div>
        <script>
            document.addEventListener("alpine:init", () => {
                Alpine.data("queueApp", () => ({
                    queue: {
                        pending: [],
                        completed: [],
                        failed: [],
                        downloading: [],
                    },
                    pingIntervalId: null, // Declare pingIntervalId here
                    progressMap: {}, // Store progress and speed by item ID
                    async init() {
                        this.connectWS();
                        await this.getQueue();
                    },
                    async getQueue() {
                        try {
                            const response = await fetch("/queue");
                            if (response.ok) {
                                const data = await response.json();
                                // Ensure downloading items have progress and speed fields
                                if (data.downloading) {
                                    data.downloading = data.downloading.map(item => ({
                                        ...item,
                                        progress: item.progress || 0,
                                        downloadSpeed: item.downloadSpeed || "",
                                    }));
                                }
                                this.queue = data;
                            }
                        } catch (error) {
                            console.error("Failed to fetch queue:", error);
                        }
                    },
                    async addToQueue() {
                        const linkInput = document.getElementById("link-input");
                        const link = linkInput.value.trim();
                        if (!link) return;
                        try {
                            const response = await fetch("/queue", {
                                method: "POST",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({ link }),
                            });
                            if (response.ok) {
                                linkInput.value = "";
                            } else {
                                console.error("Failed to add to queue");
                            }
                        } catch (error) {
                            console.error("Error adding to queue:", error);
                        }
                    },
                    async deleteItem(id) {
                        try {
                            const response = await fetch(`/queue/${id}`, {
                                method: "DELETE",
                            });
                            if (!response.ok) {
                                console.error("Failed to delete item");
                            }
                        } catch (error) {
                            console.error("Error deleting item:", error);
                        }
                    },
                    async cancelDownload(id) {
                        try {
                            const response = await fetch(`/queue/${id}/cancelDownload`, {
                                method: "PUT",
                            });
                            if (!response.ok) {
                                console.error("Failed to cancel download");
                            }
                        } catch (error) {
                            console.error("Error cancelling download:", error);
                        }
                    },
                    async moveItem(id, direction) {
                        try {
                            const response = await fetch(`/queue/${id}/move`, {
                                method: "PUT",
                                headers: { "Content-Type": "application/json" },
                                body: JSON.stringify({ direction }),
                            });
                            if (!response.ok) {
                                console.error("Failed to move item");
                            }
                        } catch (error) {
                            console.error("Error moving item:", error);
                        }
                    },
                    async retryItem(id) {
                        try {
                            const response = await fetch(`/queue/${id}/retry`, {
                                method: "PUT",
                            });
                            if (!response.ok) {
                                console.error("Failed to retry item");
                            }
                        } catch (error) {
                            console.error("Error retrying item:", error);
                        }
                    },
                    async clearCompleted() {
                        try {
                            const response = await fetch("/queue/completed", {
                                method: "DELETE",
                            });
                            if (!response.ok) {
                                console.error("Failed to clear completed");
                            }
                        } catch (error) {
                            console.error("Error clearing completed:", error);
                        }
                    },
                    async clearFailed() {
                        try {
                            const response = await fetch("/queue/failed", {
                                method: "DELETE",
                            });
                            if (!response.ok) {
                                console.error("Failed to clear failed");
                            }
                        } catch (error) {
                            console.error("Error clearing failed:", error);
                        }
                    },
                    connectWS() {
                        const ws = new WebSocket(
                            "ws://" + window.location.host + "/ws",
                        );
                        ws.onmessage = (event) => {
                            try {
                                const msg = JSON.parse(event.data);
                                if (msg.type === "progress") {
                                    this.progressMap = {
                                        ...this.progressMap,
                                        [msg.itemId]: {
                                            progress: msg.progress,
                                            downloadSpeed: msg.downloadSpeed,
                                        },
                                    };
                                } else if (msg.type === "update") {
                                    this.getQueue();
                                }
                            } catch (error) {
                                console.error("Failed to parse WebSocket message:", error);
                            }
                        };
                        ws.onopen = () => {
                            this.startPing(ws);
                        };
                        ws.onclose = () => {
                            // Clear ping interval on close to prevent orphaned timers
                            if (this.pingIntervalId) {
                                clearInterval(this.pingIntervalId);
                                this.pingIntervalId = null;
                            }
                            setTimeout(() => this.connectWS(), 1000);
                        };
                        ws.onerror = (error) => {
                            console.error("WebSocket error:", error);
                        };
                    },
                    startPing(ws) {
                        // Clear any existing ping interval before setting a new one
                        if (this.pingIntervalId) {
                            clearInterval(this.pingIntervalId);
                        }
                        this.pingIntervalId = setInterval(() => {
                            if (ws.readyState === WebSocket.OPEN) {
                                ws.send("ping");
                            }
                        }, 30000); // Send ping every 30 seconds
                    },
                    async clearFailed() {
                        try {
                            const response = await fetch("/queue/failed", {
                                method: "DELETE",
                            });
                            if (!response.ok) {
                                console.error("Failed to clear failed");
                            }
                        } catch (error) {
                            console.error("Error clearing failed:", error);
                        }
                    },
                    async clearCompleted() {
                        try {
                            const response = await fetch("/queue/completed", {
                                method: "DELETE",
                            });
                            if (!response.ok) {
                                console.error("Failed to clear completed");
                            }
                        } catch (error) {
                            console.error("Error clearing completed:", error);
                        }
                    },
                    formatSize(bytes) {
                        if (bytes === 0) return "0 B";
                        const k = 1024;
                        const sizes = ["B", "KB", "MB", "GB"];
                        const i = Math.floor(Math.log(bytes) / Math.log(k));
                        return (
                            parseFloat((bytes / Math.pow(k, i)).toFixed(1)) +
                            " " +
                            sizes[i]
                        );
                    },
                    formatDate(dateString) {
                        const date = new Date(dateString);
                        return date.toLocaleString();
                    },
                }));
            });
        </script>
    </body>
</html>
